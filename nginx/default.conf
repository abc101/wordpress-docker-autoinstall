server {
    listen 80;
    server_name <your.domain>;

    root /var/www/html;
    index index.php index.html;
    client_max_body_size 128M;

    # --- Real IP from LXC reverse proxy ---
    set_real_ip_from [LXC_PROXY_IP];           # â† LXC Proxy IP
    set_real_ip_from 172.16.0.0/12;  # Docker Internal Network
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    # --- Multi site wp-admin redirection ---
    rewrite ^/([_0-9a-zA-Z-]+/)?wp-admin$ $scheme://$host$uri/ permanent;
    if (!-e $request_filename) {
        rewrite ^/([_0-9a-zA-Z-]+/)?(wp-(content|admin|includes).*) /$2 last;
        rewrite ^/([_0-9a-zA-Z-]+/)?(.*\.php)$ /$2 last;
    }

    # --- WordPress permalink handling ---
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # --- FastCGI Cache Configuration ---
    set $no_cache 0;

    # --- Do not cache if any of the following conditions are met ---
    if ($request_method = POST) {
        set $no_cache 1;
    }
    if ($query_string != "") {
        set $no_cache 1;
    }
    if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_logged_in") {
        set $no_cache 1;
    }

    # --- PHP-FPM Configuration ---
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        
        # Connect to the PHP container on port 9000
        fastcgi_pass php:9000;
        
        fastcgi_index index.php;
        include fastcgi_params;
        
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;

        # --- Performance Tuning for Divi Builder ---
        # Increased timeout and buffer sizes to prevent "White Screen of Death"
        # or loading issues when using heavy page builders like Divi.
        fastcgi_read_timeout 120s;
        fastcgi_buffers 16 32k;
        fastcgi_buffer_size 64k;
        fastcgi_busy_buffers_size 128k;

        # --- HTTPS Force for Reverse Proxy ---
        # Crucial for Proxmox -> VM -> Docker setup.
        # Forces WordPress to believe it is running on HTTPS/443.
        # This prevents infinite redirect loops and mixed content errors.
        fastcgi_param HTTP_X_FORWARDED_PROTO $http_x_forwarded_proto;
        fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
        fastcgi_param HTTP_X_FORWARDED_HOST $host;

        # --- FastCGI Caching Directives ---
        fastcgi_cache WORDPRESS;
        fastcgi_cache_valid 200 301 302 60m;
        fastcgi_cache_bypass $no_cache;
        fastcgi_no_cache $no_cache;
       
        # --- Custom Headers for Cache Status ---
        add_header X-Cache-Enabled "true" always;
        add_header X-FastCGI-Cache $upstream_cache_status always;
        add_header Cache-Control "public, max-age=3600" always;
    }

    # --- Security Hardening ---
    
    # Deny access to sensitive files
    location ~* /(wp-config\.php|readme\.html|license\.txt|wp-admin/install\.php) { 
        deny all; 
    }
    
    # Deny access to version control directories
    location ~* /\.(git|svn|hg) { 
        deny all; 
    }
    
    # Deny access to environment and config files
    location ~* \.(env|ini|log)$ { 
        deny all; 
    }
    
    # Block PHP execution in the uploads directory (Major security fix)
    location ~* /wp-content/uploads/.*\.php$ { 
        deny all; 
    }

    # Hide Apache-specific files (.htaccess)
    location ~ /\.ht { 
        deny all; 
    }

    # Block XML-RPC to prevent brute-force attacks
    # (Comment this out if you use the WordPress Mobile App or Jetpack)
    location = /xmlrpc.php { 
        return 444; 
    }

    # --- Static Assets Caching ---
    # Log suppression for common assets and long browser caching
    location = /favicon.ico { 
        log_not_found off; 
        access_log off; 
    }
    
    location = /robots.txt { 
        log_not_found off; 
        access_log off; 
        allow all; 
    }

    location ~* \.(?:css|js|jpg|jpeg|png|gif|ico|svg|webp|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        log_not_found off;
        access_log off;
        try_files $uri =404;
    }

    location @fallback {
        try_files $uri $uri/ /index.php?$args;
    }
}