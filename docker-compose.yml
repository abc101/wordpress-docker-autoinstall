# Define volumes based on values (can also be defined in .env if needed)
volumes:
  db_data:   
  app_data:  
  redis_data:   

# Define networks
networks:
  net:
    driver: bridge

services:
  # 1. Database (MariaDB)
  db:
    image: mariadb:10.11
    restart: always
    environment:
      # Read credentials automatically from the .env file
      MARIADB_ROOT_PASSWORD: "${DB_ROOT_PASSWORD}"
      MARIADB_DATABASE: "${DB_DATABASE}"
      MARIADB_USER: "${DB_USER}"
      MARIADB_PASSWORD: "${DB_USER_PASSWORD}"
      MARIADB_CHARACTER_SET_SERVER: utf8mb4
      MARIADB_COLLATION_SERVER: utf8mb4_unicode_ci
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - net
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -u$${MARIADB_USER} -p$${MARIADB_PASSWORD} -h 127.0.0.1 --silent"]
      interval: 10s
      timeout: 3s
      retries: 10
  
  # 2. Redis (Object Cache)
  redis:
    image: redis:7-alpine
    restart: always
    command: ["redis-server","--appendonly","yes","--save","60","1000"]
    volumes:
      - redis_data:/data
    networks: 
      - net
    healthcheck:
      test: ["CMD","redis-cli","ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # 2. PHP (PHP-FPM)
  php:
    build: .
    restart: always
    depends_on:
      - db 
      - redis 
    volumes:
      - app_data:/var/www/html
      - ./php/uploads.ini:/usr/local/etc/php/conf.d/uploads.ini:ro
      - ./php/opcache.ini:/usr/local/etc/php/conf.d/opcache.ini:ro
    networks:
      - net
    healthcheck:
      test: ["CMD-SHELL", "SCRIPT_NAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect 127.0.0.1:9000 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 30
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1.0' 
          memory: '1G'
        reservations:
          cpus: '0.5' 
          memory: '256M' 

  # 3. Web Server (Nginx)
  nginx:
    image: nginx:alpine
    restart: always
    depends_on:
      php:
        condition: service_healthy
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
    ports:
      - "${HOST_PORT}:80"
    volumes:
      - app_data:/var/www/html:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - net
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1/ || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 30
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: '512M'
        reservations:
          cpus: '0.25'
          memory: '128M'
